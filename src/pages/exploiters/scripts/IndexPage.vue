<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import type { FormInstance, FormRules } from 'element-plus'
import { useI18n } from 'vue-i18n'
import { retrieveScripts, fetchScript, createScript, modifyScript } from 'src/api/scripts'
import { retrieveDictionarySubset } from 'src/api/dictionaries'
import type { Script, Dictionary } from 'src/types'
import { Icon } from '@iconify/vue'
import { groupByKey, hasAction } from 'src/utils'


const { t } = useI18n()

const loading = ref<boolean>(false)
const datas = ref<Array<Script>>([])
const scriptTypeOptions = ref<Array<Dictionary>>([])

const visible = ref<boolean>(false)
const previewVisible = ref<boolean>(false)

const formRef = ref<FormInstance>()
const initialValues: Script = {
  id: undefined,
  name: '',
  icon: '',
  version: '',
  type: undefined,
  content: ''
}
const form = ref<Script>({ ...initialValues })
const rules = reactive<FormRules<typeof form>>({
  name: [
    { required: true, message: t('inputText', { field: t('name') }), trigger: 'blur' },
  ],
  type: [
    { required: true, message: t('selectText', { field: t('type') }), trigger: 'blur' }
  ],
  version: [
    { required: true, message: t('inputText', { field: t('category') }), trigger: 'blur' },
  ]
})

/**
 * 加载列表
 */
async function load() {
  retrieveScripts().then(res => {
    datas.value = res.data
  })
}

async function loadScriptType() {
  retrieveDictionarySubset(600).then(res => {
    scriptTypeOptions.value = res.data
  })
}
/**
 * 加载
 * @param id 主键
 */
async function loadOne(id: number) {
  form.value = { ...initialValues }
  fetchScript(id).then(res => {
    form.value = res.data
  })
}

onMounted(() => {
  load()
  loadScriptType()
})

/**
 * 详情
 * @param id 主键
 */
function showRow(id: number | undefined) {
  if (id) {
    loadOne(id)
  }
  previewVisible.value = true
}

function saveRow(id?: number) {
  form.value = { ...initialValues }
  if (id) {
    loadOne(id)
  }
  visible.value = true
}

function onSubmit(formEl: FormInstance | undefined) {
  if (!formEl) return

  formEl.validate((valid) => {
    if (valid) {
      loading.value = true
      if (form.value.id) {
        modifyScript(form.value.id, form.value).then(() => {
          load()
          visible.value = false
        }).finally(() => { loading.value = false })
      } else {
        createScript(form.value).then(() => {
          load()
          visible.value = false
        }).finally(() => { loading.value = false })
      }
    }
  })
}
</script>

<template>
  <ElSpace size="large" fill class="w-full">
    <ElCard shadow="never">
      <ElRow :gutter="20" justify="space-between">
        <ElCol :span="16" class="text-left">
          <ElButton v-if="hasAction($route.name, 'create')" title="create" type="primary" @click="saveRow()">
            <Icon icon="material-symbols:add-rounded" width="18" height="18" />{{ $t('create') }}
          </ElButton>
        </ElCol>

        <ElCol :span="8" class="text-right">
          <ElTooltip class="box-item" effect="dark" :content="$t('refresh')" placement="top">
            <ElButton title="view" plain circle @click="load">
              <Icon icon="material-symbols:refresh-rounded" width="18" height="18" />
            </ElButton>
          </ElTooltip>
        </ElCol>
      </ElRow>
    </ElCard>

    <ElCard shadow="never">
      <ElCollapse v-if="datas && datas.length > 0">
        <ElCollapseItem v-for="(items, group) in groupByKey(datas, 'type')" :key="group" :title="group as string"
          :name="group">
          <div class="grid gap-4 mt-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
            <ElCard shadow="never" class="text-center cursor-pointer" v-for="item in items" :key="item.id"
              @click="showRow(item.id)" body-class="hover:bg-[var(--el-bg-color-page)]">
              <ElImage :src="item.icon" class="w-14 h-14" />
              <div>
                <p class="my-1 text-md text-[var(--el-text-color-regular)]">
                  {{ item.name }}: {{ item.version }}
                </p>
              </div>
            </ElCard>
          </div>
        </ElCollapseItem>
      </ElCollapse>

      <ElEmpty v-else :image-size="300" />
    </ElCard>
  </ElSpace>

  <!-- form -->
  <ElDialog v-model="visible" align-center :title="$t('scripts')" width="50%" :max-height="600">
    <ElForm ref="formRef" :model="form" :rules="rules" label-position="top">
      <ElRow :gutter="20">
        <ElCol :span="12">
          <ElFormItem :label="$t('name')" prop="name">
            <ElInput v-model="form.name" :placeholder="$t('inputText', { field: $t('name') })" />
          </ElFormItem>
        </ElCol>
        <ElCol :span="6">
          <ElFormItem :label="$t('type')" prop="type">
            <ElSelect v-model="form.type">
              <ElOption v-for="item in scriptTypeOptions" :key="item.id" :label="item.name" :value="item.name" />
            </ElSelect>
          </ElFormItem>
        </ElCol>
        <ElCol :span="6">
          <ElFormItem :label="$t('category')" prop="version">
            <ElInput v-model="form.version" :placeholder="$t('inputText', { field: $t('category') })" />
          </ElFormItem>
        </ElCol>
      </ElRow>
      <ElRow :gutter="20">
        <ElCol>
          <ElFormItem :label="$t('content')" prop="content">
            <ElInput v-model="form.content" type="textarea" :rows="22"
              :placeholder="$t('inputText', { field: $t('content') })" />
          </ElFormItem>
        </ElCol>
      </ElRow>
    </ElForm>
    <template #footer>
      <ElButton title="cancel" @click="visible = false">
        <Icon icon="material-symbols:close" width="18" height="18" />{{ $t('cancel') }}
      </ElButton>
      <ElButton title="submit" type="primary" :loading="loading" @click="onSubmit(formRef)">
        <Icon icon="material-symbols:check-circle-outline-rounded" width="18" height="18" /> {{ $t('submit') }}
      </ElButton>
    </template>
  </ElDialog>

  <ElDialog v-model="previewVisible" show-close :title="$t('details')">
    <p class="my-1 text-lg text-[var(--el-text-color-regular)]">{{ form.name }}: {{ form.version }}</p>
    <CodeRender :content="form.content" />
  </ElDialog>
</template>
